---
title: "Introduction to OncoRegimenFinder"  
author: "Meera Y. Patel, MD"
date: `r Sys.Date()`
description: > 
    Learn how to write the OncoRegimenFinder Tables
output: 
    rmarkdown::html_vignette:
      toc: true
      number_sections: true
      df_print: paged
vignette: >
  %\VignetteIndexEntry{ntroduction to OncoRegimenFinder}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of OncoRegimenFinder is to write tables that derive antineoplastic drug combinations from every patient in the OMOP CDM instance. The execution occurs in 2 overarching steps:  
1. Subsetting the Drug Exposure table for antineoplastic drugs  
1. Executing an algorithm that derives antineoplastic drug combinations based on overlaps in the window of time created by adding and subtracting the `date_lag_input` in days from the start date of the drug exposure. This initial resultset is then joined onto itself for a number of iterations determined by `regimen_repeats`, the maximum number of drugs in derived drug combinations.  

It is important to note that the procedure shown below will run an algorithm with a set `date_lag_input` and `regimen_repeats` across the entire OMOP CDM Drug Exposure Table. Though the ultimate goal is to enable retrieval of derived drug combinations from the final `writeDatabaseSchema.regimenIngredientTable` via a join on the `person_id` field, specific cohorts may require different `date_lag_input` and `regimen_repeats`. For example, esophageal carcinoma patients tend to have regimens executed in blocks of 2 weeks instead of 30 days and the algorithm may return more accurate results with a `date_lag_input` of 15 days. In these cases, it is recommended to rerun this process on the specific cohort in a cohort-specific set of tables.  

# Procedure
## Load Packages  

```{r setup, echo=TRUE,eval=TRUE,message=FALSE,results="hide"}
library(tidyverse)
library(OncoRegimenFinder)
```

```{r, echo=FALSE,eval=TRUE,message=FALSE,results="hide"}
library(fantasia)
conn <- fantasia::connectOMOP()
```

## Set Parameters  
It is recommended that the parameters are centralized at the start of execution to ensure that arguments remain consistent across all function calls. 

```{r settings, eval=TRUE}
# Schema of Source Person and Drug Exposure Tables
cdmDatabaseSchema <- "omop_cdm_2"

# Output Schema and Tables
writeDatabaseSchema <- "patelm9"
drugExposureIngredientTable <- "ingredient_exposure"
cohortTable <- "oncoregimenfinder_cohort"
regimenTable <- "oncoregimenfinder_regimen"
regimenStagingTable <- "oncoregimenfinder_regimen_staging"
vocabularyTable <- "oncoregimenfinder_vocabulary"
regimenIngredientTable <- "oncoregimenfinder_regimen_ingredients"

# OMOP Vocabulary Drug Classes to filter Drug Exposures for
drug_classification_id_input <- c(#ATC Antineoplastics (OncoRegimenFinder::atc_antineoplastics_id)
                                 21601387, 
                                 #HemOnc Classes (OncoRegimenFinder::hemonc_classes)
                                 35101847, 
                                 35807195, 
                                 35807466, 
                                 35807470, 
                                 35807489)
false_positive_id <- 
                #OncoRegimenFinder::falsepositives
                c(45775396, 1304850, 792993, 19010482, 19089602, 
                  19080458, 19104221, 19065450, 1510328, 42903942, 
                  1354698, 1551860, 19003472, 1356009, 40244464, 
                  1303425, 745466, 1389464, 19025194, 740910, 1710612, 
                  35606631, 19003999, 985708, 45775206, 1308432, 1522957, 
                  1760616, 950637, 1300978, 44816310, 1500211, 1506270, 
                  923645, 19061406, 40171288, 1388796, 40168303, 975125, 
                  1507705, 1511449, 1738521, 1548195, 1518254, 40222444, 
                  1713332, 1112807, 19014878, 19034726, 984232, 1525866, 
                  989482, 1550557, 1551099, 924120, 904351)

# Date difference when assessing for drug combinations in the Drug Exposures table
date_lag_input <- 30
regimen_repeats <- 5

```

# Table Setup  
Core Tables needed are a vocabulary table and the ingredient exposures table:

# Create Vocabulary Table  

```{r, eval=FALSE,echo=TRUE}

createVocabTable(conn = conn,
                                    writeDatabaseSchema = "patelm9",
                                    cdmDatabaseSchema = cdmDatabaseSchema,
                                    vocabularyTable = "oncoregimenfinder_vocabulary")

```

##### Vocabulary Table 
A Vocabulary Table is created that maps the HemOnc ontology Regimen Concept Name from the OMOP Vocabulary Concept Table to string aggregates of the individual Component Concept Names derived by the algorithm.  

```{r, echo=FALSE, eval=TRUE, cache=TRUE}

vocabularyTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = "patelm9",
                                               tableName = "oncoregimenfinder_vocabulary",
                                               n = 20,
                                               n_type = "random"))

print(vocabularyTableData)

```


### Ingredient Exposure Table 
* All the Drug Exposure Table `drug_concept_ids` are mapped to their RxNorm Ingredient and stored in a Ingredient Exposures Table.

```{r}
OncoRegimenFinder::buildIngredientExposuresTable(conn = conn,
                                                 cdmDatabaseSchema = cdmDatabaseSchema,
                                                 writeDatabaseSchema = writeDatabaseSchema,
                                                 drugExposureIngredientTable = drugExposureIngredientTable)
```

```{r}
grep(pattern = "ingredient_exposure",
    pg13::lsTables(conn = conn,
                   schema = "patelm9"),
    ignore.case = T,
    value = TRUE) %>% 
        rubix::map_names_set(function(x) pg13::query(conn = conn,
                                          pg13::renderRowCount(schema = "patelm9",
                                                   tableName = x))) %>% 
        dplyr::bind_rows(.id = "Table") %>% 
        dplyr::rename(RowCount = count)
```



# Creating a Core Set of Tables
The core set of tables are produced on the entire Drug Exposures Table using the set parameters as determined in this script. 

## Steps  
1. Cohort, Regimen, and a copy of Regimen as "Regimen Staging" Tables are written. 
1. Regimen Table undergoes further processing by combining overlapping instances of an ingredient start date and +/- the date lag input over the number of regimen repeats.  
1. A final Regimen Ingredient Table joins the Vocabulary Table with the Regimen Table to map drug combinations derived from this algorithm back to the HemOnc ontology and other OMOP Concepts  

### Create Cohort, Regimen and Regimen Staging Tables

```{r, eval=FALSE, echo=TRUE}

OncoRegimenFinder::buildCohortRegimenTable(conn = conn,
                                           cdmDatabaseSchema = cdmDatabaseSchema,
                                           writeDatabaseSchema = writeDatabaseSchema,
                                           cohortTable = cohortTable,
                                           regimenTable = regimenTable,
                                           drug_classification_id_input = drug_classification_id_input,
                                           false_positive_id = false_positive_id)

```

#### Cohort Table  
The `Cohort Table` selects for the Person Id, Drug Exposure Id with Start and End Dates for all Drug Concept Ids that are RxNorm Ingredients representing that Drug Exposure filtered for all descendants of the curated Drug Cl argument.  

```{r cohort, eval=TRUE, echo=FALSE, cache=TRUE}

cohortTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = "patelm9",
                                               tableName = "oncoregimenfinder_cohort",
                                               n = 20,
                                               n_type = "random"))

print(cohortTableData)

```



```{r cohortcount, echo=FALSE,eval=TRUE}
grep(pattern = "oncoregimenfinder_cohort",
    pg13::lsTables(conn = conn,
                   schema = "patelm9"),
    ignore.case = T,
    value = TRUE) %>% 
        rubix::map_names_set(function(x) pg13::query(conn = conn,
                                          pg13::renderRowCount(schema = "patelm9",
                                                   tableName = x))) %>% 
        dplyr::bind_rows(.id = "Table") %>% 
        dplyr::rename(RowCount = count)
  

```


###### Regimen Staging Table  
The Regimen and Regimen Staging Tables, are identical to one another at this point, are a subset of Cohort Table of the Person Id, Drug Exposure Id, Ingredient Name, and the Start Date of exposure to that Ingredient. The Regimen Table will be processed further while the Regimen Staging Table serves as a reference back to the Regimen Table's original state before being processed by algorithm. The Regimen Staging Table is also to source of Regimens used to process special cohort tables. 

```{r, echo=FALSE, eval=TRUE,cache=TRUE}

regimenStagingTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = "patelm9",
                                               tableName = "oncoregimenfinder_regimen_staging",
                                               n = 20,
                                               n_type = "random"))

print(regimenStagingTableData)

```


```{r regimenstagingcount, echo=FALSE, eval=TRUE}
grep(pattern = "oncoregimenfinder_regimen_staging",
    pg13::lsTables(conn = conn,
                   schema = "patelm9"),
    ignore.case = T,
    value = TRUE) %>% 
        rubix::map_names_set(function(x) pg13::query(conn = conn,
                                          pg13::renderRowCount(schema = "patelm9",
                                                   tableName = x))) %>% 
        dplyr::bind_rows(.id = "Table") %>% 
        dplyr::rename(RowCount = count)
```


#### Processing the Regimen Table  
The Regimen Table is grouped by Person Id, Drug Exposure Id, Ingredient and Ingredient Start Date and joined onto itself based on overlapping window of time by +/= the Date Lag Input parameter and iterated on based on the Regimen Repeats given.  

```{r, eval=FALSE,echo=TRUE}

OncoRegimenFinder::processRegimenTable(conn = conn,
                    writeDatabaseSchema = writeDatabaseSchema,
                    regimenTable = regimenTable,
                    date_lag_input = date_lag_input,
                    regimen_repeats = regimen_repeats)

```

##### Regimen Table  

```{r, echo=FALSE, eval=TRUE, cache=TRUE}

regimenTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = "patelm9",
                                               tableName = "oncoregimenfinder_regimen",
                                               n = 20,
                                               n_type = "random"))

print(regimenTableData)

```


```{r regimencount, echo=FALSE, eval=TRUE}
grep(pattern = paste("oncoregimenfinder_regimen_staging", "oncoregimenfinder_regimen_ingredients", sep = "|"),
    pg13::lsTables(conn = conn,
                   schema = "patelm9"),
    ignore.case = T,
    value = TRUE,
    invert = TRUE) %>% 
  purrr::map(function(x) grep("oncoregimenfinder_regimen", x, ignore.case = T, value = TRUE)) %>% 
  purrr::keep(~length(.)==1) %>% 
  unlist() %>% 
  rubix::map_names_set(function(x) pg13::query(conn = conn,
                                          pg13::renderRowCount(schema = "patelm9",
                                                   tableName = x))) %>% 
        dplyr::bind_rows(.id = "Table") %>% 
        dplyr::rename(RowCount = count)
```

#### Final Step: Creating the Regimen Ingredient Table   

```{r, eval=FALSE, echo = TRUE}
createRegimenIngrTable(conn = conn,
                       writeDatabaseSchema = "patelm9",
                       cohortTable = "oncoregimenfinder_cohort",
                       regimenTable = "oncoregimenfinder_regimen",
                       regimenIngredientTable = "oncoregimenfinder_regimen_ingredients",
                       vocabularyTable = "oncoregimenfinder_vocabulary")
```

##### Regimen Ingredient Table  

```{r, echo=FALSE, eval=TRUE, cache=TRUE}
regimenIngrTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = "patelm9",
                                               tableName = "oncoregimenfinder_regimen_ingredients",
                                               n = 20,
                                               n_type = "random"))

print(regimenIngrTableData)

```
``


```{r regingrcount, echo=FALSE, eval=TRUE}
grep(pattern = "oncoregimenfinder_regimen_ingredients",
    pg13::lsTables(conn = conn,
                   schema = "patelm9"),
    ignore.case = T,
    value = TRUE) %>% 
        rubix::map_names_set(function(x) pg13::query(conn = conn,
                                          pg13::renderRowCount(schema = "patelm9",
                                                   tableName = x))) %>% 
        dplyr::bind_rows(.id = "Table") %>% 
        dplyr::rename(RowCount = count)
```


```{r,echo=FALSE,eval=TRUE,message=FALSE,results="hide"}
fantasia::dcOMOP(conn = conn,
                 remove = TRUE)
```

