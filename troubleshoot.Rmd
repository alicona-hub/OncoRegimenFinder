---
title: "setup-maintenance"
output: html
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### Package Load

```{r setup}
library(OncoRegimenFinder)
```

```{r, echo=FALSE,eval=TRUE,message=FALSE,results="hide"}
library(fantasia)
conn <- fantasia::connectOMOP()
```

### Parameters  
It is recommended that the parameters are centralized at the start of execution to ensure that arguments remain consistent across all function calls.  

```{r settings, eval=FALSE}
# Schema of Source Person and Drug Exposure Tables
cdmDatabaseSchema = "omop_cdm_2"

# Output Schema and Tables
writeDatabaseSchema = "patelm9"
cohortTable = "oncoregimenfinder_all_drugs_cohort"
regimenTable = "oncoregimenfinder_all_drugs_regimen"
regimenStagingTable = "oncoregimenfinder_all_drugs_regimen_staging"
vocabularyTable = "oncoregimenfinder_all_drugs_vocabulary"
regimenIngredientTable= "oncoregimenfinder_all_drugs_regimen_ingredients"

# OMOP Vocabulary Drug Classes to filter Drug Exposures for
drug_classification_id_input = c(21601387,
                                35807188,
                                35807277,
                                35807189, as.integer(OncoRegimenFinder::topclasses$cancer_drug_category_concept_id))

# Date difference when assessing for drug combinations in the Drug Exposures table
date_lag_input = 30
regimen_repeats = 5

```

### Steps  
1. Cohort, Regimen, and a copy of Regimen as "Regimen Staging" Tables are written. Tables that are already present in the schema are copied to a new table appended with the date.  
1. Regimen Table undergoes further processing by combining overlapping instances of an ingredient start date and +/- the date lag input over the number of regimen repeats desired.  
1. A Separate Vocabulary Table is created that maps the HemOnc Regimen Concept Name to string aggregates of the individual Component Concept Names  
1. A final Regimen Ingredient Table joins the Vocabulary Table with the Regimen Table to map drug combinations derived from this algorithm back to HemOnc and other OMOP Concepts  

#### Create Cohort, Regimen and Regimen Staging Tables

```{r, eval=FALSE}

OncoRegimenFinder::buildCohortRegimenTable(conn = conn,
                                           cdmDatabaseSchema = cdmDatabaseSchema,
                                           writeDatabaseSchema = writeDatabaseSchema,
                                           cohortTable = cohortTable,
                                           regimenTable = regimenTable,
                                           drug_classification_id_input = drug_classification_id_input)
```

###### Cohort Table  
The `Cohort Table` includes the Person Id, Drug Exposure Id with Start and End Dates, and Ingredient representing that Drug Exposure filtered for all descendants of the Drug Classification Concept Id argument.  

```{r cohortTable, eval=TRUE, echo=FALSE}

cohortTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = writeDatabaseSchema,
                                               tableName = cohortTable,
                                               n = 20,
                                               n_type = "random"))

print(cohortTableData)

```

###### Regimen Staging Table  
The Regimen and Regimen Staging Tables, are identical to one another at this point, are a subset of Cohort Table of the Person Id, Drug Exposure Id, Ingredient Name, and the Start Date of exposure to that Ingredient. The Regimen Table will be processed further while the Regimen Staging Table serves as a reference back to the Regimen Table's original state before being processed by algorithm.   

```{r, echo=FALSE, eval=TRUE}

regimenStagingTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = writeDatabaseSchema,
                                               tableName = regimenStagingTable,
                                               n = 20,
                                               n_type = "random"))

print(regimenStagingTableData)

```

#### Processing the Regimen Table  
The Regimen Table is grouped by Person Id, Drug Exposure Id, Ingredient and Ingredient Start Date and joined onto itself based on overlapping window of time by +/= the Date Lag Input parameter and iterated on based on the Regimen Repeats given.  

```{r, eval=FALSE,echo=TRUE}

OncoRegimenFinder::processRegimenTable(conn = conn,
                    writeDatabaseSchema = writeDatabaseSchema,
                    regimenTable = regimenTable,
                    date_lag_input = 30,
                    regimen_repeats = 5)

```

##### Regimen Table  

```{r, echo=FALSE, eval=TRUE}

regimenTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = writeDatabaseSchema,
                                               tableName = regimenTable,
                                               n = 20,
                                               n_type = "random"))

print(regimenTableData)

```

#### Create Vocabulary Table  

```{r, eval=FALSE,echo=TRUE}

OncoRegimenFinder::createVocabTable(conn = conn,
                                    writeDatabaseSchema = writeDatabaseSchema,
                                    cdmDatabaseSchema = cdmDatabaseSchema,
                                    vocabularyTable = vocabularyTable)

```

##### Vocabulary Table 

```{r, echo=FALSE, eval=TRUE}

vocabularyTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = writeDatabaseSchema,
                                               tableName = vocabularyTable,
                                               n = 20,
                                               n_type = "random"))

print(vocabularyTableData)

```

#### Final Step: Creating the Regimen Ingredient Table   

```{r, eval=FALSE, echo = TRUE}
createRegimenIngrTable(conn = conn,
                       writeDatabaseSchema = writeDatabaseSchema,
                       cohortTable = cohortTable,
                       regimenTable = regimenTable,
                       regimenIngredientTable = regimenIngredientTable,
                       vocabularyTable = vocabularyTable)
```

##### Regimen Ingredient Table  

```{r, echo=FALSE, eval=TRUE}
regimenIngrTableData <-
  pg13::query(conn = conn,
              sql_statement = pg13::buildQuery(schema = writeDatabaseSchema,
                                               tableName = regimenIngredientTable,
                                               n = 20,
                                               n_type = "random"))

print(regimenIngrTableData)

```


```{r,echo=FALSE,eval=TRUE,message=FALSE,results="hide"}
fantasia::dcOMOP(conn = conn,
                 remove = TRUE)
```

